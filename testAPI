#!/bin/bash

set -e

### Couleurs ###
GREEN="\033[1;32m"
RED="\033[1;31m"
NC="\033[0m" # No Color

echo -e "${GREEN}ğŸš€ Lancement de l'installation du projet...${NC}"

### 1. VÃ©rification des prÃ©requis ###
check_and_install_docker() {
  if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ Docker non installÃ©. Installation...${NC}"
    curl -fsSL https://get.docker.com | sh
    sudo usermod -aG docker "$USER"
    echo -e "${GREEN}âœ… Docker installÃ©. Veuillez redÃ©marrer votre session.${NC}"
  else
    echo -e "${GREEN}âœ… Docker est dÃ©jÃ  installÃ©.${NC}"
  fi
}

check_and_install_docker_compose() {
  if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}âŒ Docker Compose non installÃ©. Installation...${NC}"
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
      -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    echo -e "${GREEN}âœ… Docker Compose installÃ©.${NC}"
  else
    echo -e "${GREEN}âœ… Docker Compose est dÃ©jÃ  installÃ©.${NC}"
  fi
}

check_and_install_docker
check_and_install_docker_compose

### 2. Chargement de lâ€™environnement ###
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
  echo -e "${GREEN}âœ… Fichier .env chargÃ©.${NC}"
else
  echo -e "${RED}âš ï¸  Fichier .env manquant ! Merci d'en crÃ©er un avant de continuer.${NC}"
  exit 1
fi

### 3. CrÃ©ation des dossiers persistants ###
mkdir -p data/db data/limesurvey_uploads

### 4. VÃ©rification des fichiers critiques ###
[ -f docker-compose.yml ] || { echo -e "${RED}âŒ docker-compose.yml manquant !${NC}"; exit 1; }
[ -f python_worker/requirements.txt ] || echo "# requirements" > python_worker/requirements.txt
[ -f python_worker/main.py ] || echo "print('Hello from worker')" > python_worker/main.py

### 5. Build & Lancement ###
echo -e "${GREEN}ğŸ“¦ Lancement de docker-compose...${NC}"
docker-compose up -d --build

### 6. VÃ©rification de lâ€™Ã©tat des services ###
check_service() {
  local name="$1"
  local status
  status=$(docker inspect --format='{{.State.Health.Status}}' "$name" 2>/dev/null || echo "unknown")
  
  if [ "$status" == "healthy" ] || [ "$status" == "running" ]; then
    echo -e "${GREEN}âœ… Service $name est OK ($status)${NC}"
  else
    echo -e "${RED}âŒ Service $name en erreur ou inconnu (status: $status)${NC}"
  fi
}

echo -e "${GREEN}ğŸ” VÃ©rification de l'Ã©tat des conteneurs...${NC}"
services=$(docker-compose ps -q)
for id in $services; do
  name=$(docker inspect --format='{{.Name}}' "$id" | cut -c2-)
  check_service "$name"
done

echo -e "${GREEN}ğŸ‰ Installation terminÃ©e avec succÃ¨s !${NC}"
