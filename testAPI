#!/bin/bash

INPUT_DIR="./INPUT"
OUTPUT_DIR="./OUTPUT"
TMP_DIR="./TMP_RECONSTRUCT"
SPLIT_SIZE="100M"

mkdir -p "$OUTPUT_DIR"
mkdir -p "$TMP_DIR"

# Boucle sur chaque fichier de INPUT
for filepath in "$INPUT_DIR"/*; do
  [ -f "$filepath" ] || continue  # Ignorer si ce n‚Äôest pas un fichier

  filename=$(basename "$filepath")
  base="${filename%.*}"

  echo "‚û°Ô∏è  Traitement de $filename..."

  # 1. Cr√©er archive tar.gz
  archive_path="$OUTPUT_DIR/${base}.tar.gz"
  tar -czf "$archive_path" -C "$INPUT_DIR" "$filename"

  # 2. Split de l'archive
  split_prefix="$OUTPUT_DIR/${base}_partie_"
  split -b "$SPLIT_SIZE" "$archive_path" "$split_prefix"

  # 3. Reconstitution de l'archive
  cat "$split_prefix"* > "$TMP_DIR/${base}_reconstruit.tar.gz"

  # 4. Extraction test
  extract_dir="$TMP_DIR/${base}_extract"
  mkdir -p "$extract_dir"
  if tar -xzf "$TMP_DIR/${base}_reconstruit.tar.gz" -C "$extract_dir"; then
    echo "‚úÖ Extraction OK pour $filename"

    # 5. Nettoyage
    echo "üßπ Nettoyage des fichiers temporaires..."
    rm -f "$archive_path"
    rm -f "$split_prefix"*
    rm -f "$TMP_DIR/${base}_reconstruit.tar.gz"
    rm -rf "$extract_dir"

    echo "‚úÖ $filename trait√© et nettoy√©."
  else
    echo "‚ùå √âchec de l'extraction pour $filename"
  fi

  echo "-----------------------------------"
done
