#!/bin/bash

set -e

### Couleurs ###
GREEN="\033[1;32m"
RED="\033[1;31m"
NC="\033[0m" # No Color

echo -e "${GREEN}ğŸš€ Lancement de l'installation du projet...${NC}"

### 1. VÃ©rification des prÃ©requis ###
check_and_install_docker() {
  if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ Docker non installÃ©. Installation...${NC}"
    curl -fsSL https://get.docker.com | sh
    sudo usermod -aG docker "$USER"
    echo -e "${GREEN}âœ… Docker installÃ©. Veuillez redÃ©marrer votre session.${NC}"
  else
    echo -e "${GREEN}âœ… Docker est dÃ©jÃ  installÃ©.${NC}"
  fi
}

check_and_install_docker_compose() {
  if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}âŒ Docker Compose non installÃ©. Installation...${NC}"
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
      -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    echo -e "${GREEN}âœ… Docker Compose installÃ©.${NC}"
  else
    echo -e "${GREEN}âœ… Docker Compose est dÃ©jÃ  installÃ©.${NC}"
  fi
}

check_and_install_docker
check_and_install_docker_compose

### 2. Chargement de lâ€™environnement ###
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs)
  echo -e "${GREEN}âœ… Fichier .env chargÃ©.${NC}"
else
  echo -e "${RED}âš ï¸  Fichier .env manquant ! Merci d'en crÃ©er un avant de continuer.${NC}"
  exit 1
fi

### 3. CrÃ©ation des dossiers persistants ###
mkdir -p data/db data/limesurvey_uploads

### 4. VÃ©rification des fichiers critiques ###
[ -f docker-compose.yml ] || { echo -e "${RED}âŒ docker-compose.yml manquant !${NC}"; exit 1; }
[ -f python_worker/requirements.txt ] || echo "# requirements" > python_worker/requirements.txt
[ -f python_worker/main.py ] || echo "print('Hello from worker')" > python_worker/main.py

### 5. Build & Lancement ###
echo -e "${GREEN}ğŸ“¦ Lancement de docker-compose...${NC}"
docker-compose up -d --build

### 6. VÃ©rification de lâ€™Ã©tat des services ###
check_service() {
  local name="$1"
  local status
  status=$(docker inspect --format='{{.State.Health.Status}}' "$name" 2>/dev/null || echo "unknown")
  
  if [ "$status" == "healthy" ] || [ "$status" == "running" ]; then
    echo -e "${GREEN}âœ… Service $name est OK ($status)${NC}"
  else
    echo -e "${RED}âŒ Service $name en erreur ou inconnu (status: $status)${NC}"
  fi
}

echo -e "${GREEN}ğŸ” VÃ©rification de l'Ã©tat des conteneurs...${NC}"
services=$(docker-compose ps -q)
for id in $services; do
  name=$(docker inspect --format='{{.Name}}' "$id" | cut -c2-)
  check_service "$name"
done

echo -e "${GREEN}ğŸ‰ Installation terminÃ©e avec succÃ¨s !${NC}"





Parfait. Voici un script install.sh idempotent, professionnel et robuste, adaptÃ© Ã  ton dÃ©pÃ´t GitLab existant. Il :

VÃ©rifie la prÃ©sence de Docker et Docker Compose, et les installe si besoin.

VÃ©rifie lâ€™existence des fichiers essentiels (.env, docker-compose.yml, etc.)

CrÃ©e les dossiers manquants.

Lance les conteneurs via docker-compose up -d --build.

VÃ©rifie la santÃ© de chaque service.

Est idempotent : il ne refait rien inutilement.




ğŸ¯ Objectif
CrÃ©er un fichier .sql contenant lâ€™intÃ©gralitÃ© de la base de donnÃ©es LimeSurvey, afin de :

RÃ©aliser une sauvegarde manuelle ou automatisÃ©e

Migrer la base vers un autre environnement

Conserver un snapshot versionnÃ© de lâ€™Ã©tat de la base

âš™ï¸ Fonctionnement de lâ€™export
Le script utilise la commande mysqldump pour extraire toute la base, puis :

VÃ©rifie que le dossier db_dumps/ existe, ou le crÃ©e.

GÃ©nÃ¨re un fichier .sql horodatÃ© avec la structure :

bash
Copier
Modifier
./db_dumps/limesurvey_db_YYYYMMDD_HHMMSS.sql
Affiche un message de confirmation en cas de succÃ¨s ou dâ€™Ã©chec.

ğŸ§‘â€ğŸ’» Ã‰tapes dÃ©taillÃ©es pour exÃ©cuter un export
1. Modifier les paramÃ¨tres de connexion
Dans le script limesurvey_db.sh, configure les variables :

bash
Copier
Modifier
DB_HOST="localhost"             # Adresse de la base (ex: localhost, 127.0.0.1, ou nom du conteneur Docker)
DB_PORT="3306"                  # Port MariaDB (3306 par dÃ©faut)
DB_USER="limesurvey_user"       # Utilisateur ayant les droits SELECT sur la base
DB_PASS="votre_mot_de_passe"    # Mot de passe de l'utilisateur
DB_NAME="limesurvey_db"         # Nom exact de la base
DUMP_DIR="./db_dumps"           # Dossier de destination des exports
2. ExÃ©cuter le script
bash
Copier
Modifier
./limesurvey_db.sh
3. Choisir l'option "1"
markdown
Copier
Modifier
=== LimeSurvey DB Script ===
1. Exporter la base
2. Importer un dump
Choix (1/2) : 1
4. VÃ©rifier le rÃ©sultat
Une fois lâ€™opÃ©ration terminÃ©e, tu verras un message du type :

csharp
Copier
Modifier
ğŸ“¤ Export de la base de donnÃ©es 'limesurvey_db' vers './db_dumps/limesurvey_db_20250604_153212.sql'...
âœ… Export rÃ©ussi.
ğŸ“ Exemple de structure des fichiers aprÃ¨s plusieurs exports
pgsql
Copier
Modifier
db_dumps/
â”œâ”€â”€ limesurvey_db_20250601_110215.sql
â”œâ”€â”€ limesurvey_db_20250602_114450.sql
â””â”€â”€ limesurvey_db_20250604_153212.sql
ğŸ›¡ Bonnes pratiques
Sauvegarder avant toute opÃ©ration critique (import, mise Ã  jour de LimeSurveyâ€¦)

Ne jamais exposer ces fichiers en public (ils contiennent potentiellement des donnÃ©es sensibles)

Versionner les dumps dans un dÃ©pÃ´t Git privÃ© si besoin de suivi historique

Utiliser un systÃ¨me de rotation si les dumps sont gÃ©nÃ©rÃ©s automatiquement (pour Ã©viter lâ€™accumulation)
