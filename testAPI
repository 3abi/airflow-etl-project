#!/bin/bash

# === Configuration ===
DB_HOST="localhost"
DB_PORT="3306"
DB_USER="limesurvey_user"
DB_PASS="votre_mot_de_passe"
DB_NAME="limesurvey_db"
DUMP_DIR="./db_dumps"
DATE=$(date +"%Y%m%d_%H%M%S")

# === Fonctions ===

function export_db() {
    mkdir -p "$DUMP_DIR"
    DUMP_FILE="${DUMP_DIR}/${DB_NAME}_${DATE}.sql"

    echo "Export de la base de données '${DB_NAME}' vers '${DUMP_FILE}'..."
    mysqldump -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" > "$DUMP_FILE"

    if [[ $? -eq 0 ]]; then
        echo "Export réussi."
    else
        echo "Échec de l'export."
        exit 1
    fi
}

function import_db() {
    read -p "Entrez le chemin du fichier .sql à importer : " SQL_FILE

    if [[ ! -f "$SQL_FILE" ]]; then
        echo "Fichier non trouvé : $SQL_FILE"
        exit 1
    fi

    echo "Cela va écraser la base '${DB_NAME}'. Continuer ? (o/n)"
    read -r confirm
    if [[ "$confirm" != "o" ]]; then
        echo "Import annulé."
        exit 0
    fi

    echo "Suppression du contenu existant..."
    mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "DROP DATABASE IF EXISTS \`$DB_NAME\`; CREATE DATABASE \`$DB_NAME\`;"

    echo "Import de '$SQL_FILE' dans '${DB_NAME}'..."
    mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$SQL_FILE"

    if [[ $? -eq 0 ]]; then
        echo "Import réussi."
    else
        echo "Échec de l'import."
        exit 1
    fi
}

# === Menu principal ===
echo "=== LimeSurvey DB Script ==="
echo "1. Exporter la base"
echo "2. Importer un dump"
read -p "Choix (1/2) : " CHOICE

case "$CHOICE" in
    1) export_db ;;
    2) import_db ;;
    *) echo "Choix invalide." ;;
esac
